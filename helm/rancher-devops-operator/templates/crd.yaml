apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: projects.rancher.devops.io
  labels:
    {{- include "rancher-devops-operator.labels" . | nindent 4 }}
spec:
  group: rancher.devops.io
  names:
    kind: Project
    listKind: ProjectList
    plural: projects
    singular: project
    shortNames:
      - pr
  scope: Cluster
  versions:
    - name: v1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              required:
                - clusterName
                - displayName
              properties:
                clusterName:
                  type: string
                  description: Name of the Rancher cluster (not cluster ID)
                displayName:
                  type: string
                  description: Display name for the Rancher project
                description:
                  type: string
                  description: Description of the project
                namespaces:
                  type: array
                  description: List of namespaces to create and associate with this project
                  items:
                    type: string
                members:
                  type: array
                  description: Project members with their roles
                  items:
                    type: object
                    required:
                      - role
                    properties:
                      principalId:
                        type: string
                        description: Principal ID (user or group)
                      principalName:
                        type: string
                        description: Optional principal name to resolve to an ID if principalId not provided
                      role:
                        type: string
                        description: Role to assign (e.g., "project-owner", "project-member")
                managementPolicies:
                  type: array
                  description: >-
                    Management policies controlling allowed actions: "Create", "Delete", "Observe".
                    If omitted or empty, defaults to ["Create"] (Delete/Observe are opt-in).
                  items:
                    type: string
                    enum:
                      - Create
                      - Delete
                      - Observe
                resourceQuota:
                  type: object
                  description: Resource quotas for the project
                  properties:
                    limitsCpu:
                      type: string
                    limitsMemory:
                      type: string
                    requestsCpu:
                      type: string
                    requestsMemory:
                      type: string
                namespaceManagementPolicies:
                  type: array
                  description: >-
                    Namespace-specific management policies controlling namespace actions: "Create", "Update", "Delete".
                    If omitted or empty, defaults to ["Create","Update"] (Delete is opt-in).
                    - Create: Allows creating namespaces
                    - Update: Allows (re)assigning namespaces into or out of the Rancher project (disassociation/move)
                    - Delete: Allows deleting namespaces ONLY when controller CleanupNamespaces=true (otherwise acts like Update)
                  items:
                    type: string
                    enum:
                      - Create
                      - Update
                      - Delete
            status:
              type: object
              properties:
                projectId:
                  type: string
                  description: Rancher project ID (c-xxxxx:p-xxxxx)
                clusterId:
                  type: string
                  description: Rancher cluster ID
                phase:
                  type: string
                  description: Current phase of the resource
                createdNamespaces:
                  type: array
                  description: List of namespaces created by the operator (not merely assigned or moved)
                  items:
                    type: string
                manuallyRemovedNamespaces:
                  type: array
                  description: Namespaces manually removed in the cluster/UI that should NOT be recreated even if present in spec
                  items:
                    type: string
                lastReconcileTime:
                  type: string
                  format: date-time
                  description: Last reconciliation time
                createdTimestamp:
                  type: string
                  format: date-time
                  description: Timestamp when the controller first successfully created or took over the project
                lastUpdatedTimestamp:
                  type: string
                  format: date-time
                  description: Timestamp of last successful status update (end of reconcile)
                errorMessage:
                  type: string
                  description: Error message if any
                configuredMembers:
                  type: array
                  description: List of configured members
                  items:
                    type: string
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: Cluster
          type: string
          jsonPath: .spec.clusterName
        - name: Project ID
          type: string
          jsonPath: .status.projectId
        - name: Phase
          type: string
          jsonPath: .status.phase
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
